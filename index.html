<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Online Concertina</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<style>
  body { font-family: sans-serif; text-align: center; padding: 50px; }
  .section { display: inline-block; margin: 0 20px; vertical-align: top; }
  .row { display: flex; justify-content: center; gap: 10px; margin: 5px 0; }
  .button {
    width: 50px; height: 50px; border-radius: 50%;
    background: #eee; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    font-weight: bold; border: 2px solid #333;
    user-select: none; transition: background 0.1s;
  }
  .button.active { background: yellow; }
  .key { font-size: 14px; }
  .note { font-size: 12px; }

  .waveform-btn, .reverb-btn, .octave-btn {
    margin: 0 5px; padding: 5px 10px; border: 2px solid #333;
    border-radius: 6px; background: #eee; cursor: pointer;
    transition: background 0.1s;
  }
  .waveform-btn.active, .reverb-btn.active, .octave-btn.active { background: yellow; }

  @media (max-width: 768px) {
    body { padding: 10px; }
    .row { gap: 5px; }
    .button {
      width: 12vw; height: 12vw; max-width: 50px; max-height: 50px;
    }
    .key { font-size: 3vw; }
    .note { font-size: 2.5vw; }
  }
</style>
</head>
<body>
<h1>Online Concertina</h1>

<div id="concertina">
  <!-- Left side -->
  <div class="section" id="left">
    <div class="row">
      <div class="button" data-key="2"><div class="key">2</div><div class="note">F#5</div></div>
      <div class="button" data-key="3"><div class="key">3</div><div class="note">F5</div></div>
      <div class="button" data-key="4"><div class="key">4</div><div class="note">A5</div></div>
      <div class="button" data-key="5"><div class="key">5</div><div class="note">Ab5</div></div>
    </div>
    <div class="row">
      <div class="button" data-key="w"><div class="key">W</div><div class="note">Bb4</div></div>
      <div class="button" data-key="e"><div class="key">E</div><div class="note">B4</div></div>
      <div class="button" data-key="r"><div class="key">R</div><div class="note">D5</div></div>
      <div class="button" data-key="t"><div class="key">T</div><div class="note">D#5</div></div>
    </div>
    <div class="row">
      <div class="button" data-key="s"><div class="key">S</div><div class="note">Eb4</div></div>
      <div class="button" data-key="d"><div class="key">D</div><div class="note">E4</div></div>
      <div class="button" data-key="f"><div class="key">F</div><div class="note">G4</div></div>
      <div class="button" data-key="g"><div class="key">G</div><div class="note">G#4</div></div>
    </div>
    <div class="row">
      <div class="button" data-key="z"><div class="key">Z</div><div class="note">Ab3</div></div>
      <div class="button" data-key="x"><div class="key">X</div><div class="note">A3</div></div>
      <div class="button" data-key="c"><div class="key">C</div><div class="note">C4</div></div>
      <div class="button" data-key="v"><div class="key">V</div><div class="note">C#4</div></div>
    </div>
  </div>

  <!-- Right side -->
  <div class="section" id="right">
    <div class="row">
      <div class="button" data-key="6"><div class="key">6</div><div class="note">Eb5</div></div>
      <div class="button" data-key="7"><div class="key">7</div><div class="note">E5</div></div>
      <div class="button" data-key="8"><div class="key">8</div><div class="note">G5</div></div>
      <div class="button" data-key="9"><div class="key">9</div><div class="note">G#5</div></div>
    </div>
    <div class="row">
      <div class="button" data-key="y"><div class="key">Y</div><div class="note">Ab4</div></div>
      <div class="button" data-key="u"><div class="key">U</div><div class="note">A4</div></div>
      <div class="button" data-key="i"><div class="key">I</div><div class="note">C5</div></div>
      <div class="button" data-key="o"><div class="key">O</div><div class="note">C#5</div></div>
    </div>
    <div class="row">
      <div class="button" data-key="h"><div class="key">H</div><div class="note">D#4</div></div>
      <div class="button" data-key="j"><div class="key">J</div><div class="note">D4</div></div>
      <div class="button" data-key="k"><div class="key">K</div><div class="note">F4</div></div>
      <div class="button" data-key="l"><div class="key">L</div><div class="note">F#4</div></div>
    </div>
    <div class="row">
      <div class="button" data-key="n"><div class="key">N</div><div class="note">F3</div></div>
      <div class="button" data-key="m"><div class="key">M</div><div class="note">G3</div></div>
      <div class="button" data-key=","><div class="key">,</div><div class="note">B3</div></div>
      <div class="button" data-key="."><div class="key">.</div><div class="note">Bb3</div></div>
    </div>
  </div>
</div>

<br>
<div id="controls">
  <label>Waveform:</label>
  <button class="waveform-btn" data-wave="sine">Sine</button>
  <button class="waveform-btn" data-wave="square">Square</button>
  <button class="waveform-btn" data-wave="triangle">Triangle</button>
  <button class="waveform-btn" data-wave="sawtooth">Sawtooth</button>
  <br><br>
  <button class="reverb-btn" id="reverbToggle">Reverb: Off</button>
  <button class="octave-btn" id="octaveToggle">Octave: Off</button>
</div>

<script>
/* state */
let currentWaveform = 'sine';
let reverbOn = false;
let octaveDown = false; // when true, notes play one octave lower (freq * 0.5)

function setWaveform(type) {
  currentWaveform = type;
  document.querySelectorAll('.waveform-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.wave === type);
  });
}
setWaveform('sine');
document.querySelectorAll('.waveform-btn').forEach(btn =>
  btn.addEventListener('click', () => setWaveform(btn.dataset.wave))
);

/* audio setup */
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

/* simple artificial reverb = feedback delay */
const delayNode = audioCtx.createDelay();
delayNode.delayTime.value = 0.25;

const feedback = audioCtx.createGain();
feedback.gain.value = 0.35;

delayNode.connect(feedback);
feedback.connect(delayNode);

const reverbGain = audioCtx.createGain();
reverbGain.gain.value = 0.3;
feedback.connect(reverbGain);
reverbGain.connect(audioCtx.destination); // connect once (not per-note)

/* reverb toggle UI */
const reverbBtn = document.getElementById('reverbToggle');
reverbBtn.addEventListener('click', () => {
  reverbOn = !reverbOn;
  reverbBtn.textContent = "Reverb: " + (reverbOn ? "On" : "Off");
  reverbBtn.classList.toggle("active", reverbOn);
});

/* octave toggle UI */
const octaveBtn = document.getElementById('octaveToggle');
function toggleOctave() {
  octaveDown = !octaveDown;
  octaveBtn.textContent = 'Octave: ' + (octaveDown ? 'Down' : 'Off');
  octaveBtn.classList.toggle('active', octaveDown);
}
octaveBtn.addEventListener('click', toggleOctave);

/* mapping */
const keyMap = {
  'n': 174.61, 'm': 196.00, ',': 246.94, '.': 233.08,
  'c': 261.63, 'v': 277.18, 'z': 207.65, 'x': 220.00,
  'h': 311.13, 'j': 293.66, 'k': 349.23, 'l': 369.99,
  's': 311.13, 'd': 329.63, 'f': 392.00, 'g': 415.30,
  'w': 466.16, 'e': 493.88, 'r': 587.33, 't': 622.25,
  'y': 415.30, 'u': 440.00, 'i': 523.25, 'o': 554.37,
  '2': 739.99, '3': 698.46, '4': 880.00, '5': 830.61,
  '6': 622.25, '7': 659.25, '8': 783.99, '9': 830.61
};

const activeOscillators = Object.create(null);

function selectButton(key) {
  return document.querySelector(`.button[data-key="${CSS.escape(String(key))}"]`);
}

function playNote(rawKey) {
  const key = String(rawKey).toLowerCase();
  if (!keyMap[key] || activeOscillators[key]) return;

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = currentWaveform;

  const origFreq = keyMap[key];
  const freq = octaveDown ? origFreq * 0.5 : origFreq;
  osc.frequency.value = freq;

  const baseGain = 0.3;
  const gainLevel = Math.min(baseGain, baseGain * (100 / origFreq));

  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(gainLevel, audioCtx.currentTime + 0.01);

  // connect: dry always, wet only when reverbOn
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  if (reverbOn) gain.connect(delayNode);

  osc.start();

  activeOscillators[key] = { osc, gain };

  const button = selectButton(key);
  if (button) button.classList.add('active');
}

function stopNote(rawKey) {
  const key = String(rawKey).toLowerCase();
  const obj = activeOscillators[key];
  if (!obj) return;

  const now = audioCtx.currentTime;
  obj.gain.gain.cancelScheduledValues(now);
  obj.gain.gain.setValueAtTime(obj.gain.gain.value, now);
  obj.gain.gain.linearRampToValueAtTime(0, now + 0.05);
  obj.osc.stop(now + 0.05);

  delete activeOscillators[key];

  const button = selectButton(key);
  if (button) button.classList.remove('active');
}

/* input handling */

// spacebar toggles octave (only once per press)
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && !e.repeat) {
    e.preventDefault(); // avoid page scroll
    toggleOctave();
    return;
  }
  playNote(e.key);
});

document.addEventListener('keyup', e => {
  if (e.code === 'Space') return; // don't try to stop space as a note
  stopNote(e.key);
});

/* mouse & touch support */
document.querySelectorAll('.button').forEach(button => {
  const key = button.dataset.key;
  button.addEventListener('mousedown', () => playNote(key));
  button.addEventListener('mouseup',   () => stopNote(key));
  button.addEventListener('mouseleave',() => stopNote(key));
  button.addEventListener('touchstart', e => { e.preventDefault(); playNote(key); }, { passive: false });
  button.addEventListener('touchend',   () => stopNote(key));
});
</script>
</body>
</html>
